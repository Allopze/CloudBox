generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextIndex", "fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String              @id @default(uuid()) @db.Uuid
  email             String              @unique
  password          String?
  name              String
  role              String              @default("USER")
  avatar            String?
  emailVerified     Boolean             @default(false)
  googleId          String?             @unique
  twoFactorEnabled  Boolean             @default(false)
  twoFactorSecret   String?             // Encrypted TOTP secret
  recoveryCodes     String?             // Hashed recovery codes (JSON array)
  storageQuota      BigInt              @default(5368709120)
  storageUsed       BigInt              @default(0)
  tempStorage       BigInt              @default(0)
  maxFileSize       BigInt              @default(1073741824)
  resetToken        String?
  resetTokenExpiry  DateTime?
  verifyToken       String?
  verifyTokenExpiry DateTime?
  createdAt         DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime            @updatedAt @db.Timestamptz(6)
  activities        Activity[]
  albums            Album[]
  files             File[]
  folders           Folder[]
  refreshTokens     RefreshToken[]
  sharedWithMe      ShareCollaborator[]
  shares            Share[]             @relation("ShareOwner")
  storageRequests   StorageRequest[]
  uploadSessions    UploadSession[]
  tags              Tag[]

  @@index([email])
  @@index([createdAt])
  @@map("users")
}

model RefreshToken {
  id        String    @id @default(uuid()) @db.Uuid
  tokenHash String    @unique
  jti       String    @unique
  userId    String    @db.Uuid
  familyId  String?   @db.Uuid
  expiresAt DateTime  @db.Timestamptz(6)
  revokedAt DateTime? @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([familyId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model SignedUrl {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique
  fileId    String   @db.Uuid
  userId    String   @db.Uuid
  action    String
  expiresAt DateTime @db.Timestamptz(6)
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  @@index([token])
  @@index([expiresAt])
  @@map("signed_urls")
}

model Folder {
  id              String    @id @default(uuid()) @db.Uuid
  name            String
  color           String?
  icon            String?
  category        String?
  parentId        String?   @db.Uuid
  userId          String    @db.Uuid
  isFavorite      Boolean   @default(false)
  isTrash         Boolean   @default(false)
  isProtected     Boolean   @default(false)
  protectionHash  String?
  trashedAt       DateTime? @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @db.Timestamptz(6)
  size            BigInt    @default(0)
  files           File[]
  parent          Folder?   @relation("FolderTree", fields: [parentId], references: [id], onDelete: Cascade)
  children        Folder[]  @relation("FolderTree")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  shares          Share[]
  uploadSessions  UploadSession[]

  @@unique([name, parentId, userId])
  @@index([userId])
  @@index([parentId])
  @@index([isTrash])
  @@map("folders")
}

model File {
  id             String          @id @default(uuid()) @db.Uuid
  name           String
  originalName   String
  mimeType       String
  size           BigInt
  path           String
  thumbnailPath  String?
  folderId       String?         @db.Uuid
  userId         String          @db.Uuid
  isFavorite     Boolean         @default(false)
  isTrash        Boolean         @default(false)
  trashedAt      DateTime?       @db.Timestamptz(6)
  metadata       String?
  createdAt      DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime        @updatedAt @db.Timestamptz(6)
  transcodedPath String?
  albumFiles     AlbumFile[]
  chunks         FileChunk[]
  uploadSessions UploadSession[]
  folder         Folder?         @relation(fields: [folderId], references: [id])
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  shares         Share[]
  transcodingJob TranscodingJob?
  fileTags       FileTag[]
  versions       FileVersion[]

  @@index([userId])
  @@index([folderId])
  @@index([isTrash])
  @@index([mimeType])
  @@index([createdAt])
  // Performance: Composite indexes for common query patterns
  @@index([userId, folderId, isTrash])  // Covers file listing query
  @@index([userId, isFavorite, isTrash]) // Covers favorites query
  @@map("files")
}

model TranscodingJob {
  id        String   @id @default(uuid()) @db.Uuid
  fileId    String   @unique @db.Uuid
  status    String   @default("PENDING")
  progress  Int      @default(0)
  error     String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)
  file      File     @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("transcoding_jobs")
}

model FileChunk {
  id          String   @id @default(uuid()) @db.Uuid
  fileId      String?  @db.Uuid
  uploadId    String   @db.Uuid
  chunkIndex  Int
  totalChunks Int
  path        String
  size        BigInt
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  file        File?    @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([uploadId, chunkIndex])
  @@index([uploadId])
  @@map("file_chunks")
}

model UploadSession {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  fileId      String?  @db.Uuid
  filename    String
  mimeType    String
  totalChunks Int
  totalSize   BigInt
  folderId    String?  @db.Uuid
  status      String   @default("UPLOADING")
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  file        File?    @relation(fields: [fileId], references: [id], onDelete: SetNull)
  folder      Folder?  @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@map("upload_sessions")
}

model Share {
  id            String              @id @default(uuid()) @db.Uuid
  type          String              @default("PRIVATE")
  fileId        String?             @db.Uuid
  folderId      String?             @db.Uuid
  ownerId       String              @db.Uuid
  publicToken   String?             @unique
  password      String?
  expiresAt     DateTime?           @db.Timestamptz(6)
  downloadLimit Int?
  downloadCount Int                 @default(0)
  allowDownload Boolean             @default(true)
  createdAt     DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime            @updatedAt @db.Timestamptz(6)
  collaborators ShareCollaborator[]
  file          File?               @relation(fields: [fileId], references: [id], onDelete: Cascade)
  folder        Folder?             @relation(fields: [folderId], references: [id], onDelete: Cascade)
  owner         User                @relation("ShareOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([publicToken])
  @@index([type])
  @@map("shares")
}

model ShareCollaborator {
  id         String   @id @default(uuid()) @db.Uuid
  shareId    String   @db.Uuid
  userId     String   @db.Uuid
  permission String   @default("VIEWER")
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  share      Share    @relation(fields: [shareId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([shareId, userId])
  @@index([userId])
  @@map("share_collaborators")
}

model Album {
  id        String      @id @default(uuid()) @db.Uuid
  name      String
  color     String?
  userId    String      @db.Uuid
  coverPath String?
  createdAt DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt DateTime    @updatedAt @db.Timestamptz(6)
  files     AlbumFile[]
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
  @@map("albums")
}

model AlbumFile {
  id        String   @id @default(uuid()) @db.Uuid
  albumId   String   @db.Uuid
  fileId    String   @db.Uuid
  order     Int      @default(0)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  album     Album    @relation(fields: [albumId], references: [id], onDelete: Cascade)
  file      File     @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([albumId, fileId])
  @@index([albumId])
  @@map("album_files")
}

model Activity {
  id        String   @id @default(uuid()) @db.Uuid
  type      String
  userId    String   @db.Uuid
  fileId    String?  @db.Uuid
  folderId  String?  @db.Uuid
  details   String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("activities")
}

model CompressionJob {
  id          String   @id @default(uuid()) @db.Uuid
  type        String
  status      String   @default("PENDING")
  progress    Int      @default(0)
  inputPaths  String
  outputPath  String?
  format      String
  userId      String   @db.Uuid
  error       String?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)
  currentFile String?

  @@index([userId])
  @@index([status])
  @@map("compression_jobs")
}

model Settings {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@map("settings")
}

model EmailTemplate {
  id        String                  @id @default(uuid()) @db.Uuid
  name      String                  @unique
  subject   String
  body      String
  isDefault Boolean                 @default(false)
  createdAt DateTime                @default(now()) @db.Timestamptz(6)
  updatedAt DateTime                @updatedAt @db.Timestamptz(6)
  variables EmailTemplateVariable[]

  @@map("email_templates")
}

model EmailTemplateVariable {
  id           String        @id @default(uuid()) @db.Uuid
  templateId   String        @db.Uuid
  name         String
  defaultValue String
  description  String?
  isSystem     Boolean       @default(false)
  createdAt    DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime      @updatedAt @db.Timestamptz(6)
  template     EmailTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, name])
  @@index([templateId])
  @@map("email_template_variables")
}

model LoginAttempt {
  id        String   @id @default(uuid()) @db.Uuid
  email     String
  ipAddress String   @db.Inet
  success   Boolean  @default(false)
  userAgent String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@map("login_attempts")
}

model StorageRequest {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @db.Uuid
  requestedQuota BigInt
  currentQuota   BigInt
  reason         String?
  status         String   @default("PENDING")
  adminResponse  String?
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @db.Timestamptz(6)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("storage_requests")
}

model LegalPage {
  id        String   @id @default(uuid()) @db.Uuid
  slug      String
  locale    String   @default("es")
  title     String
  content   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@unique([slug, locale])
  @@map("legal_pages")
}

model Tag {
  id        String    @id @default(uuid()) @db.Uuid
  name      String
  color     String?
  userId    String    @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  fileTags  FileTag[]

  @@unique([name, userId])
  @@index([userId])
  @@map("tags")
}

model FileTag {
  id        String   @id @default(uuid()) @db.Uuid
  fileId    String   @db.Uuid
  tagId     String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  file      File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([fileId, tagId])
  @@index([fileId])
  @@index([tagId])
  @@map("file_tags")
}

model FileVersion {
  id          String   @id @default(uuid()) @db.Uuid
  fileId      String   @db.Uuid
  version     Int
  size        BigInt
  path        String   // Path to versioned file storage
  mimeType    String
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  createdBy   String?  @db.Uuid

  file        File     @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([createdAt])
  @@map("file_versions")
}
